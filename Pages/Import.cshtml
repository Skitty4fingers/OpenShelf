@page
@model OpenShelf.Pages.ImportModel
@{
    ViewData["Title"] = "Import Books";
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="mb-4">Import Data</h1>
        <p class="text-muted">
            Upload a CSV file to bulk import books to the shelf. 
            The system will automatically group books into series based on the "Series Name" column.
        </p>

        @if (!string.IsNullOrEmpty(Model.Message))
        {
            <div id="alert-area" class="alert alert-@Model.MessageType alert-dismissible fade show" role="alert">
                @Model.Message
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        else 
        {
            <div id="alert-area" style="display:none;" class="alert alert-info alert-dismissible fade show" role="alert">
                <span id="alert-msg"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <!-- Progress Bar -->
        <div id="progress-container" class="mb-4 d-none">
            <h5 id="progress-status" class="text-muted">Starting import...</h5>
            <div class="progress" role="progressbar" aria-label="Import Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="height: 25px;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <form id="importForm" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">Select CSV File</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recommender" class="form-label">Your Name (Recommended By)</label>
                        <input type="text" class="form-control" id="recommender" name="recommender" placeholder="e.g. Scott" >
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Start Import
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mt-4">
             <h5>Expected CSV Columns</h5>
             <small class="text-muted">
                 Title, Author, Narrated By, Purchase Date, Duration, Release Date, Ave. Rating, Genre, Series Name, Series Sequence, Product ID, ASIN, Book URL, Summary, Description, Rating Count, Publisher, Copyright, Series URL, Abridged, Language
             </small>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('importForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('file');
        if (!fileInput.files.length) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        // Append recommender if present
        const recommender = document.getElementById('recommender').value;
        if (recommender) formData.append('recommender', recommender);

        // Anti-forgery token
        const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        const token = tokenInput ? tokenInput.value : '';

        // UI Updates
        document.getElementById('progress-container').classList.remove('d-none');
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('alert-area').style.display = 'none';

        try {
            // Start Import (Async)
            const response = await fetch('?handler=StartImport', {
                method: 'POST',
                body: formData,
                headers: { 'RequestVerificationToken': token }
            });

            if (!response.ok) throw new Error("Upload failed");
            
            const result = await response.json();
            if (!result.success) throw new Error(result.message);

            const processId = result.processId;
            startPolling(processId);

        } catch (error) {
            showError(error.message);
            resetUI();
        }
    });

    function startPolling(processId) {
        console.log('Starting progress polling for processId:', processId);
        const interval = setInterval(async () => {
            try {
                const res = await fetch(`?handler=Progress&processId=${processId}`);
                if (!res.ok) {
                    console.error('Progress fetch failed:', res.status);
                    return;
                }
                const status = await res.json();
                console.log('Progress update:', status);

                updateProgress(status.percent, status.message);

                if (status.isComplete || status.isError) {
                    clearInterval(interval);
                    resetUI();
                    if (status.isError) showError(status.message);
                    else showSuccess(status.message);
                }
            } catch (err) {
                console.error('Progress polling error:', err);
            }
        }, 1000); // Poll every 1s
    }

    function updateProgress(percent, msg) {
        console.log(`Updating progress: ${percent}% - ${msg}`);
        const bar = document.getElementById('progress-bar');
        bar.style.width = percent + '%';
        bar.innerText = percent + '%';
        document.getElementById('progress-status').innerText = msg;
    }

    function showError(msg) {
        const alert = document.getElementById('alert-area');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.style.display = 'block';
        document.getElementById('alert-msg').innerHTML = msg;
    }

    function showSuccess(msg) {
        const alert = document.getElementById('alert-area');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.style.display = 'block';
        document.getElementById('alert-msg').innerHTML = msg;
    }

    function resetUI() {
        document.getElementById('submitBtn').disabled = false;
    }
</script>
}
